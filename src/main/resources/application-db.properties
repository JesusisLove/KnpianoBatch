# ==================================================================================
# KNPiano Batch工程 - 数据库专用配置文件
# 文件名: application-db.properties
# 配置目的: 解决NAS启动时MySQL与Java批处理应用的启动顺序问题
# 
# 问题背景:
# NAS在早上8:00自动启动时，MySQL容器启动慢，batch应用启动快，导致连接失败
#
# 解决方案:
# 通过增加数据库连接超时、重试机制，让batch应用耐心等待MySQL完成启动
# ==================================================================================

# ==================== 数据库连接配置 ====================
# 基本连接信息 - 这些本来分散在dev/prod配置中，现在统一管理
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# ==================== HikariCP 连接池配置 ====================
# 配置目的: 解决NAS启动时的数据库连接问题，覆盖application.properties中的默认配置

# 连接超时时间 - 从30秒增加到2分钟，给MySQL更多启动时间
spring.datasource.hikari.connection-timeout=120000

# 连接池初始化失败超时时间 - 10分钟，这是解决启动顺序问题的关键配置
spring.datasource.hikari.initialization-fail-timeout=600000

# 空闲连接超时时间 - 15分钟，比application.properties中的10分钟更长
spring.datasource.hikari.idle-timeout=900000

# 连接最大生存时间 - 1小时，比application.properties中的30分钟更长
spring.datasource.hikari.max-lifetime=3600000

# 连接池大小配置 - 覆盖application.properties中的配置
spring.datasource.hikari.maximum-pool-size=15
spring.datasource.hikari.minimum-idle=3

# 连接测试相关配置 - 新增，确保连接有效性
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.validation-timeout=10000
spring.datasource.hikari.leak-detection-threshold=60000

# ==================== Spring Batch 框架配置 ====================
# 配置目的: 避免Spring Batch在数据库未准备好时初始化失败
# 注意: 覆盖application.properties中的 spring.batch.jdbc.initialize-schema=always

# 禁用Spring Batch表的自动初始化 - 避免启动时连接失败
spring.batch.jdbc.initialize-schema=never

# 禁用应用启动时自动执行批处理作业 - 与application.properties保持一致
spring.batch.job.enabled=false

# ==================== SQL初始化配置 ====================
# 配置目的: 避免因数据库连接问题导致SQL初始化失败

# 遇到SQL错误时继续执行
spring.sql.init.continue-on-error=true

# 不自动执行SQL初始化脚本
spring.sql.init.mode=never

# ==================== 数据库连接重试配置 ====================
# 配置目的: 为DatabaseConnectionWaiter组件提供重试参数

# 最大重试次数 - 60次(每10秒一次，共10分钟)
database.connection.max-retries=60

# 重试间隔 - 10秒
database.connection.retry-interval=10000

# 总等待超时时间 - 10分钟
database.connection.total-timeout=600000

# ==================== MyBatis配置 ====================
# 注意: 这些配置已经在application.properties中存在，这里保持一致性
mybatis.config-location=classpath:mybatis/mybatis-config.xml
mybatis.mapper-locations=classpath:mybatis/mapper/*.xml
mybatis.type-aliases-package=com.liu.knbatch.entity

# ==================== 备注说明 ====================
# 1. 此文件专门解决NAS环境下的数据库启动顺序问题
# 2. 覆盖了application.properties中的部分HikariCP配置，使用更长的超时时间
# 3. 覆盖了Spring Batch的initialize-schema配置，避免启动时连接失败
# 4. 不包含日志配置，因为已有完整的logback-spring.xml
# 5. 不包含邮件配置，因为已在application.properties中配置
#
# 使用方法:
# spring.profiles.include=db
# 或者启动时: java -jar knpiano-batch.jar --spring.profiles.active=db