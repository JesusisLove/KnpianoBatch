# KNDB2020 年度月收入报告数据监视 - 部署说明

## 模块概述

**模块编号**: KNDB2020
**模块名称**: 年度月收入报告数据监视
**业务目的**: 验证年度月收入报告数据的准确性，确保应收课费 = 已支付课费 + 未支付课费
**执行频率**: 每天凌晨0:30自动执行
**创建日期**: 2025-12-16

## 已创建的文件清单

### 1. Entity类（实体类）
- `src/main/java/com/liu/knbatch/entity/KNDB2020MonthSummaryEntity.java` - 月度汇总验证实体
- `src/main/java/com/liu/knbatch/entity/KNDB2020ValidationSummaryEntity.java` - 汇总验证结果实体
- `src/main/java/com/liu/knbatch/entity/KNDB2020FeeErrorEntity.java` - 费用表错误记录实体
- `src/main/java/com/liu/knbatch/entity/KNDB2020PayErrorEntity.java` - 支付表错误记录实体

### 2. 数据访问层
- `src/main/java/com/liu/knbatch/dao/KNDB2020Dao.java` - DAO接口
- `src/main/resources/mybatis/mapper/KNDB2020Mapper.xml` - MyBatis映射文件

### 3. 业务逻辑层
- `src/main/java/com/liu/knbatch/tasklet/KNDB2020Tasklet.java` - 业务处理任务类

### 4. 配置层
- `src/main/java/com/liu/knbatch/config/KNDB2020Config.java` - Spring Batch配置类

### 5. 数据库配置
- `database/KNDB2020_config.sql` - 数据库配置脚本

## 部署步骤

### 步骤1: 执行数据库配置脚本

1. 连接到MySQL数据库
2. 执行配置脚本：
   ```bash
   mysql -u your_username -p your_database < database/KNDB2020_config.sql
   ```

3. **重要**: 修改邮件配置中的邮箱地址：
   ```sql
   UPDATE t_batch_mail_config
   SET
       email_from = '实际的发送方邮箱',
       mail_to_devloper = '实际的开发者邮箱',
       email_to_user = '实际的用户邮箱（可选）'
   WHERE job_id = 'KNDB2020';
   ```

4. 验证配置是否插入成功：
   ```sql
   -- 查看作业配置
   SELECT * FROM t_batch_job_config WHERE job_id = 'KNDB2020';

   -- 查看邮件配置
   SELECT * FROM t_batch_mail_config WHERE job_id = 'KNDB2020';
   ```

### 步骤2: 编译项目

```bash
cd /Users/kazuyoshi/Documents/KnPianoBatchRepository/KnpianoBatch
mvn clean package
```

### 步骤3: 测试手动执行（推荐先手动测试）

#### 3.1 MANUAL模式测试（指定日期）
```bash
java -jar target/knbatch-1.0.0.jar \
  --job.name=KNDB2020_MANUAL \
  --base.date=20251216
```

#### 3.2 AUTO模式测试（使用当前日期）
```bash
java -jar target/knbatch-1.0.0.jar \
  --job.name=KNDB2020_AUTO
```

### 步骤4: 查看执行日志

检查日志文件确认执行结果：
```bash
# 查看主日志
tail -f logs/knpiano-batch.log

# 查看错误日志
tail -f logs/knpiano-batch-error.log
```

### 步骤5: 验证邮件发送

1. 检查开发者邮箱是否收到邮件
2. 如果配置了用户邮箱，检查用户邮箱是否收到邮件
3. 验证邮件内容是否包含：
   - 验证结果汇总
   - 月度汇总明细（如有错误月份）
   - 费用表错误记录（如有）
   - 支付表错误记录（如有）

### 步骤6: 启动Web服务模式（生产部署）

```bash
# 启动Web服务，包含自动调度功能
java -jar target/knbatch-1.0.0.jar
```

Web服务启动后：
- 访问 http://localhost:8081 进入管理界面
- 可以在作业配置管理页面查看和修改KNDB2020配置
- 可以在邮件配置管理页面修改邮件设置
- 系统将按照cron表达式（每天凌晨0:30）自动执行

## 业务逻辑说明

### 验证流程

1. **步骤1**: 获取指定年度的整体验证结果汇总
   - 统计总月份数、正确月份数、错误月份数
   - 判断最终结果是否全部正确

2. **步骤2**: 获取月度汇总明细
   - 查询每个月份的应收、已支付、未支付课费
   - 计算差额并标记验证结果

3. **步骤3**: 如果发现错误月份，检查错误来源
   - 检查费用表：一个lesson_id是否对应了多个lsn_fee_id
   - 检查支付表：一个lsn_fee_id是否对应了多个lsn_pay_id

4. **步骤4**: 发送邮件通知
   - **所有情况都发送邮件**（包括验证通过和验证失败）
   - 给开发者发送详细报告
   - 给用户发送简洁摘要（如果配置了用户邮箱）

### 邮件内容说明

#### 开发者邮件内容
- 验证结果汇总（总月份数、正确/错误月份数、最终结果）
- 月度汇总明细表格（如有错误月份）
- 费用表错误记录详情（如有）
- 支付表错误记录详情（如有）
- 完整执行日志

#### 用户邮件内容（简洁版）
- 验证结果概要
- 错误数量统计
- 提示联系管理员查看详情

## 注意事项

### 1. 数据依赖
模块依赖以下视图和表：
- `v_total_lsnfee_with_paid_unpaid_every_month` - 月度课费汇总视图
- `t_info_lesson_fee` - 课程费用表
- `t_info_lesson_pay` - 课程支付表

**请确保这些视图和表存在且数据正确！**

### 2. 年份动态化
- 系统会根据base.date参数自动提取年份
- 例如：base.date=20251216 → 查询2025年的数据
- AUTO模式使用当前系统日期

### 3. 邮件发送策略
- **当前配置：所有执行结果都发送邮件**（包括正确和错误情况）
- 如果将来需要改为"仅错误时发送"，请修改 KNDB2020Tasklet.java 中的邮件发送逻辑

### 4. 数据一致性
如果发现以下情况，请立即检查：
- 错误月份数 > 0，但费用表和支付表都没有错误记录
  - 这可能表示存在新的数据问题或未发现的程序BUG

### 5. 性能考虑
- 视图查询可能较慢，建议在数据量大时添加索引
- 建议在低峰期（凌晨）执行

## 测试建议

### 正常数据测试
1. 准备一年的正确数据
2. 执行MANUAL模式
3. 验证邮件显示"✓ 全部正确！"

### 异常数据测试
1. 人为制造错误数据（例如：一个lesson_id对应多个lsn_fee_id）
2. 执行MANUAL模式
3. 验证邮件包含错误记录详情

### 边界测试
1. 测试年初（1月）和年末（12月）的数据
2. 测试空数据（某个月没有课程记录）
3. 测试特殊字符在错误记录中的显示

## 故障排查

### 问题1: 找不到视图 v_total_lsnfee_with_paid_unpaid_every_month
**原因**: 视图不存在或命名错误
**解决**: 检查数据库中是否存在该视图，确认视图定义正确

### 问题2: 邮件未发送
**原因**: 邮件服务未配置或邮箱地址错误
**解决**:
- 检查环境变量：EMAIL_USERNAME, EMAIL_PASSWORD, SPRING_MAIL_HOST, SPRING_MAIL_PORT
- 检查 t_batch_mail_config 表中的邮箱地址配置
- 查看日志中的邮件发送错误信息

### 问题3: 编译错误
**原因**: 依赖项缺失或版本不匹配
**解决**:
- 执行 `mvn clean install` 重新构建
- 检查 pom.xml 中的依赖项配置

### 问题4: 数据验证结果不准确
**原因**: 视图数据有问题
**解决**:
- 直接在数据库中执行SQL验证视图数据
- 检查 t_info_lesson_fee 和 t_info_lesson_pay 表的 del_flg 字段

## 后续改进建议

1. **性能优化**: 如果数据量大，考虑添加数据库索引
2. **通知优化**: 可以添加钉钉/企业微信通知
3. **报表功能**: 可以生成Excel报表附件
4. **历史记录**: 可以将验证结果保存到历史表
5. **自动修复**: 对于某些错误，可以考虑添加自动修复功能

## 联系方式

如有问题，请联系开发团队。

---
**文档版本**: 1.0.0
**最后更新**: 2025-12-16
