<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.liu.knbatch.dao.KNDB1010Dao">

    <!-- 结果映射 -->
    <resultMap id="LessonResultMap" type="com.liu.knbatch.entity.Lesson">
        <result property="stuId" column="stu_id"/>
        <result property="subjectId" column="subject_id"/>
        <result property="subjectSubId" column="subject_sub_id"/>
        <result property="schedualDate" column="schedual_date"/>
        <result property="lessonId" column="lesson_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 获取排课钢琴错误级别的课程记录用的SQL -->
    <select id="selectIncorrectPianoLevelLessons" parameterType="string" resultMap="LessonResultMap">
        SELECT lsn.* 
        FROM v_info_lesson lsn
        WHERE 1 = 1
        AND NOT EXISTS (
            SELECT 1 
            FROM v_latest_subject_info_from_doc_tmp doc
            WHERE doc.stu_id = lsn.stu_id
            AND doc.subject_id = lsn.subject_id
            AND doc.subject_sub_id = lsn.subject_sub_id
        )
        AND LEFT(lsn.schedual_date, 7) = #{targetMonth}
        ORDER BY lsn.stu_id, lsn.subject_id, lsn.schedual_date
    </select>

    <!-- 统计排课钢琴错误级别的课程记录数 -->
    <select id="countIncorrectPianoLevelLessons" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM v_info_lesson lsn
        WHERE 1 = 1
        AND NOT EXISTS (
            SELECT 1 
            FROM v_latest_subject_info_from_doc_tmp doc
            WHERE doc.stu_id = lsn.stu_id
            AND doc.subject_id = lsn.subject_id
            AND doc.subject_sub_id = lsn.subject_sub_id
        )
        AND LEFT(lsn.schedual_date, 7) = #{targetMonth}
    </select>

    <!-- 给错误的钢琴级别课程进行数据矫正（更新操作） -->
    <update id="updateIncorrectPianoLevelLessons" parameterType="string">
        UPDATE t_info_lesson lsn
        INNER JOIN (
            SELECT doc1.* 
            FROM v_latest_subject_info_from_doc_tmp doc1
            INNER JOIN (
                SELECT lsn.stu_id, lsn.subject_id
                FROM v_info_lesson lsn
                WHERE 1 = 1 
                AND NOT EXISTS (
                    SELECT 1 
                    FROM v_latest_subject_info_from_doc_tmp doc 
                    WHERE doc.stu_id = lsn.stu_id
                    AND doc.subject_id = lsn.subject_id 
                    AND doc.subject_sub_id = lsn.subject_sub_id 
                )
                AND LEFT(lsn.schedual_date, 7) = #{targetMonth}
                GROUP BY lsn.stu_id, lsn.subject_id
            ) lsn1 ON doc1.stu_id = lsn1.stu_id 
                   AND doc1.subject_id = lsn1.subject_id
        ) doc ON lsn.stu_id = doc.stu_id 
             AND lsn.subject_id = doc.subject_id
        SET lsn.subject_sub_id = doc.subject_sub_id
        WHERE 1 = 1 
        AND NOT EXISTS (
            SELECT 1 
            FROM v_latest_subject_info_from_doc_tmp doc 
            WHERE doc.stu_id = lsn.stu_id
            AND doc.subject_id = lsn.subject_id 
            AND doc.subject_sub_id = lsn.subject_sub_id 
        )
        AND LEFT(lsn.schedual_date, 7) = #{targetMonth}
    </update>

</mapper>